<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocumentaciÃ³n TÃ©cnica - EstaciÃ³n MeteorolÃ³gica</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1 class="logo">ğŸŒ¤ï¸ EstaciÃ³n MeteorolÃ³gica</h1>
            <ul class="nav-menu">
                <li><a href="index.html">Inicio</a></li>
                <li><a href="readme.html">README</a></li>
                <li><a href="documentacion.html">DocumentaciÃ³n</a></li>
                <li><a href="estado.html">Estado</a></li>
                <li><a href="changelog.html">Cambios</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <article class="doc-content">
            <p><h1>ğŸŒ¤ï¸ Sistema ETL Incremental PostgreSQL â†’ MinIO (Bronce-Silver)</h1></p><p>Sistema automatizado de extracciÃ³n, transformaciÃ³n y carga (ETL) que extrae <strong>solo datos nuevos</strong> de PostgreSQL, los almacena en MinIO (capa Bronce) y automÃ¡ticamente los <strong>limpia y consolida</strong> en una Ãºnica capa Silver.</p><p><strong>CaracterÃ­sticas principales:</strong>
<ul><li>âœ… ExtracciÃ³n incremental desde PostgreSQL</li></ul>
<ul><li>âœ… Limpieza automÃ¡tica (Bronce â†’ Silver)</li></ul>
<ul><li>âœ… ConsolidaciÃ³n en archivo Ãºnico por tabla</li></ul>
<ul><li>âœ… Estrategia REPLACE: mantiene solo la versiÃ³n mÃ¡s reciente</li></ul>
<ul><li>âœ… Arquitectura modular OOP</li></ul>
<ul><li>âœ… EjecuciÃ³n automÃ¡tica cada 5 minutos</li></ul></p><p>---</p><p><h2>ğŸ“‹ Contenido</h2></p><p>1. <a href="#descripciÃ³n-general">DescripciÃ³n General</a>
2. <a href="#arquitectura-y-flujo">Arquitectura y Flujo</a>
3. <a href="#instalaciÃ³n-y-configuraciÃ³n">InstalaciÃ³n y ConfiguraciÃ³n</a>
4. <a href="#uso-y-ejecuciÃ³n">Uso y EjecuciÃ³n</a>
5. <a href="#estructura-del-cÃ³digo">Estructura del CÃ³digo</a>
6. <a href="#capa-bronce">Capa Bronce</a>
7. <a href="#capa-silver">Capa Silver</a>
8. <a href="#limpieza-automÃ¡tica">Limpieza AutomÃ¡tica</a>
9. <a href="#soluciÃ³n-de-problemas">SoluciÃ³n de Problemas</a></p><p>---</p><p><h2>ğŸ“‹ DescripciÃ³n General</h2></p><p><h3>Â¿QuÃ© hace?</h3></p><p><code></code>`
PostgreSQL
    â†“
[ExtracciÃ³n Incremental]
    â†“
MinIO Bronce (CSV crudos)
    â†“
[Limpieza AutomÃ¡tica]
    â†“
MinIO Silver (CSV consolidado + limpio)
<code></code>`</p><p><h3>Flujo de Datos AutomÃ¡tico</h3></p><p><strong>Ciclo completo cada 5 minutos:</strong></p><p>1. <strong>ExtracciÃ³n</strong> (2-3 seg)
   - Detecta columnas de rastreo
   - Extrae solo registros nuevos
   - Guarda en MinIO Bronce (CSV)</p><p>2. <strong>Limpieza</strong> (1-2 seg)
   - Descarga todos los CSV de Bronce
   - Los combina en un Ãºnico DataFrame
   - Aplica reglas de limpieza
   - Guarda en MinIO Silver (CSV Ãºnico)
   - Elimina versiones antiguas</p><p>3. <strong>Espera</strong> (5 minutos)</p><p>4. <strong>Repite</strong> indefinidamente</p><p>---</p><p><h2>ğŸ—ï¸ Arquitectura y Flujo</h2></p><p><h3>Diagrama de Componentes</h3></p><p><code></code>`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MAIN.PY                                â”‚
â”‚              (Sistema ETL + Limpieza)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚
    â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Pipeline  â”‚   â”‚  DataCleaner â”‚
â”‚   (Extrae)  â”‚   â”‚  (Limpia)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
             â”‚               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
    â”‚  PostgreSQL     â”‚     â”‚
    â”‚  (Origen)       â”‚     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                       â”‚                       â”‚
    â–¼                       â”‚                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MinIO Bronce â”‚           â”‚               â”‚ MinIO Silver â”‚
â”‚ (CSV crudos) â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ (CSV limpio) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
<code></code>`</p><p><h3>Directorio del Proyecto</h3></p><p><code></code>`
Estacion_Meteorologica/
â”œâ”€â”€ main.py                          # ğŸš€ Punto de entrada (orquesta todo)
â”œâ”€â”€ run_scheduler.ps1                # Script PowerShell
â”œâ”€â”€ run_scheduler.sh                 # Script Bash
â”‚
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ database_config.py           # Config PostgreSQL
â”‚   â””â”€â”€ minio_config.py              # Config MinIO
â”‚
â”œâ”€â”€ etl/
â”‚   â”œâ”€â”€ pipeline.py                  # OrquestaciÃ³n extracciÃ³n
â”‚   â”œâ”€â”€ table_processor.py           # Procesamiento por tabla
â”‚   â”œâ”€â”€ cleaners/                    # ğŸ†• MÃ“DULO DE LIMPIEZA
â”‚   â”‚   â”œâ”€â”€ <strong>init</strong>.py
â”‚   â”‚   â””â”€â”€ data_cleaner.py          # ğŸ†• Limpieza automÃ¡tica
â”‚   â”œâ”€â”€ extractors/
â”‚   â”‚   â”œâ”€â”€ data_extractor.py        # ExtracciÃ³n incremental
â”‚   â”‚   â””â”€â”€ table_inspector.py       # InspecciÃ³n de schema
â”‚   â”œâ”€â”€ writers/
â”‚   â”‚   â”œâ”€â”€ csv_writer.py            # Escritura CSV
â”‚   â”‚   â””â”€â”€ file_writer.py           # Interfaz base
â”‚   â”œâ”€â”€ uploaders/
â”‚   â”‚   â””â”€â”€ minio_uploader.py        # Carga a MinIO
â”‚   â”œâ”€â”€ control/
â”‚   â”‚   â””â”€â”€ control_manager.py       # GestiÃ³n de estado
â”‚   â”œâ”€â”€ etl_state.py                 # Estado JSON
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ db_utils.py              # Utilidades BD
â”‚
â”œâ”€â”€ .etl_state.json                  # Estado incremental
â”‚
â”œâ”€â”€ notebooks/
â”‚   â””â”€â”€ templates/
â”‚       â””â”€â”€ limpieza_template.ipynb   # Notebook alternativa
â”‚
â””â”€â”€ venv_meteo/                      # Entorno virtual
<code></code>`</p><p>---</p><p><h2>ğŸš€ InstalaciÃ³n y ConfiguraciÃ³n</h2></p><p><h3>Requisitos Previos</h3></p><p><ul><li>Python 3.8+</li></ul>
<ul><li>PostgreSQL</li></ul>
<ul><li>MinIO (servidor local o remoto)</li></ul>
<ul><li>Windows: PowerShell 5+, Linux/Mac: Bash</li></ul></p><p><h3>Paso 1: Crear Entorno Virtual</h3></p><p><code></code>`powershell
<h1>Windows</h1>
python -m venv venv_meteo
.\venv_meteo\Scripts\Activate</p><p><h1>Linux/Mac</h1>
python3 -m venv venv_meteo
source venv_meteo/bin/activate
<code></code>`</p><p><h3>Paso 2: Instalar Dependencias</h3></p><p><code></code>`bash
pip install pandas sqlalchemy psycopg2-binary minio
<code></code>`</p><p><h3>Paso 3: Configurar Variables de Entorno</h3></p><p><strong>En <code>run_scheduler.ps1</code> (Windows):</strong>
<code></code>`powershell
$env:PG_DB = "postgres"
$env:PG_USER = "postgres"
$env:PG_PASS = "1234"
$env:PG_HOST = "10.202.50.50"</p><p>$env:MINIO_ENDPOINT = "localhost:9000"
$env:MINIO<em>ACCESS</em>KEY = "minioadmin"
$env:MINIO<em>SECRET</em>KEY = "minioadmin"
$env:MINIO_BUCKET = "meteo-bronze"
<code></code>`</p><p><strong>En <code>run_scheduler.sh</code> (Linux/Mac):</strong>
<code></code>`bash
export PG_HOST="10.202.50.50"
export PG_USER="postgres"
export PG_PASS="1234"
export PG_DB="postgres"
export MINIO_ENDPOINT="localhost:9000"
export MINIO<em>ACCESS</em>KEY="minioadmin"
export MINIO<em>SECRET</em>KEY="minioadmin"
export MINIO_BUCKET="meteo-bronze"
<code></code>`</p><p><h3>Paso 4: Crear Buckets en MinIO</h3></p><p><code></code>`bash
<h1>Configurar alias MinIO</h1>
mc alias set myminio http://localhost:9000 minioadmin minioadmin</p><p><h1>Crear buckets</h1>
mc mb myminio/meteo-bronze
mc mb myminio/meteo-silver</p><p><h1>Verificar</h1>
mc ls myminio
<code></code>`</p><p>---</p><p><h2>â–¶ï¸ Uso y EjecuciÃ³n</h2></p><p><h3>EjecuciÃ³n Principal (RECOMENDADO)</h3></p><p><code></code>`powershell
<h1>Activar entorno</h1>
.\venv_meteo\Scripts\Activate</p><p><h1>Ejecutar</h1>
python main.py</p><p><h1>Salida esperada:</h1>
<h1>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</h1>
<h1>ğŸš€ Iniciando Sistema ETL Incremental PostgreSQL â†’ MinIO</h1>
<h1>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</h1>
<h1></h1>
<h1>--- CICLO 1: 2025-12-03 09:40:12 ---</h1>
<h1>Procesando tabla: sensor_readings</h1>
<h1>   ğŸ“Š Incremental (timestamp)</h1>
<h1>[INFO] Iniciando limpieza automÃ¡tica...</h1>
<h1>================================================================================</h1>
<h1>[PROCESO] Limpiando sensor_readings</h1>
<h1>...</h1>
<code></code>`</p><p><strong>Presionar Ctrl+C para detener.</strong></p><p><h3>Salida Esperada</h3></p><p><code></code>`
--- CICLO 1: 2025-12-03 09:40:12 ---</p><p>Procesando tabla: sensor_readings
   ğŸ“Š Incremental (timestamp)
      > 2025-10-23T12:11:04.612475+00:00
   ğŸ“¦ Registros nuevos: 97
   âœ… Subido a MinIO: sensor<em>readings</em>bronce_20251203093625.csv</p><p>ğŸ¯ RESUMEN: 97 registros nuevos en este batch.</p><p>[INFO] Iniciando limpieza automÃ¡tica...</p><p>================================================================================
[PROCESO] Limpiando sensor_readings
================================================================================
[INFO] Encontrados 1 archivo(s) de sensor_readings
       - sensor<em>readings/sensor</em>readings<em>bronce</em>20251203093625.csv
[INFO] Combinando 1 archivo(s)...
[OK] Cargado: sensor<em>readings</em>bronce_20251203093625.csv (97 filas)
[OK] DataFrames combinados: 97 filas totales
[INFO] Limpiando datos...
[OK] Duplicados eliminados: 97 â†’ 97
[OK] Outliers en temperature: 13 reemplazados con mediana (24.00)
[OK] Columnas innecesarias eliminadas
[OK] Valores invÃ¡lidos filtrados: 0 eliminadas â†’ 97 filas finales
[INFO] Guardando en Silver (estrategia REPLACE)...
[EXITO] sensor_readings: 97 filas guardadas en Silver
[INFO] Archivo: sensor<em>readings</em>silver_20251203094013.csv
[INFO] Eliminando versiones antiguas...
[OK] Eliminado: sensor<em>readings</em>silver_20251203093847.csv
[OK] sensor<em>readings: 1 archivos eliminados (mantiene: sensor</em>readings<em>silver</em>20251203094013.csv)</p><p>[INFO] Esperando 300s...
<code></code>`</p><p>---</p><p><h2>ğŸ”§ Estructura del CÃ³digo</h2></p><p><h3>ConfiguraciÃ³n</h3></p><p><h4><strong>DatabaseConfig</strong></h4>
<code></code>`python
from config import DatabaseConfig</p><p>config = DatabaseConfig()
<h1>Propiedades:</h1>
<h1>- user: str (usuario PostgreSQL)</h1>
<h1>- password: str (contraseÃ±a)</h1>
<h1>- host: str (IP/dominio)</h1>
<h1>- database: str (nombre BD)</h1>
<h1>- connection_url: str (URL formateada)</h1>
<code></code>`</p><p><h4><strong>MinIOConfig</strong></h4>
<code></code>`python
from config import MinIOConfig</p><p>config = MinIOConfig()
<h1>Propiedades:</h1>
<h1>- endpoint: str (IP:puerto)</h1>
<h1>- access_key: str</h1>
<h1>- secret_key: str</h1>
<h1>- bucket: str (meteo-bronze)</h1>
<code></code>`</p><p><h3>Pipeline Principal</h3></p><p><h4><strong>ETLPipeline</strong> (etl/pipeline.py)</h4>
Coordina extracciÃ³n de todas las tablas.</p><p><code></code>`python
pipeline = ETLPipeline(db<em>config, minio</em>config)
total<em>records = pipeline.process</em>batch()  # Una ronda
pipeline.run<em>continuous(interval</em>seconds=300)  # Bucle infinito
<code></code>`</p><p><h4><strong>TableProcessor</strong> (etl/table_processor.py)</h4>
Procesa una tabla individual.</p><p><code></code>`python
processor = TableProcessor(connection, table<em>name, state</em>manager, ...)
records = processor.process()
<code></code>`</p><p><strong>Flujo:</strong>
1. Detecta columna de rastreo
2. Obtiene Ãºltimo valor procesado
3. Extrae datos nuevos
4. Guarda en Bronce
5. Actualiza estado</p><p><h3>ExtracciÃ³n</h3></p><p><h4><strong>DataExtractor</strong> (etl/extractors/data_extractor.py)</h4>
Extrae datos incrementales.</p><p><code></code>`python
extractor = DataExtractor(connection, "sensor_readings", "timestamp", "timestamp")
df = extractor.extract<em>incremental(last</em>value="2025-10-23T12:11:04.612475+00:00")
<code></code>`</p><p><h4><strong>TableInspector</strong> (etl/extractors/table_inspector.py)</h4>
Inspecciona estructura de tabla.</p><p><code></code>`python
inspector = TableInspector(connection)
tables = inspector.get<em>all</em>tables()
tracking<em>col, tracking</em>type = inspector.detect<em>tracking</em>column("sensor_readings")
<code></code>`</p><p><h3>Limpieza AutomÃ¡tica ğŸ†•</h3></p><p><h4><strong>DataCleaner</strong> (etl/cleaners/data_cleaner.py)</h4>
Limpia datos de Bronce y genera Silver.</p><p><code></code>`python
cleaner = DataCleaner(minio_config)
rows<em>saved = cleaner.clean</em>table("sensor_readings")
<code></code>`</p><p><strong>Proceso automÃ¡tico:</strong>
1. Lista archivos CSV en Bronce
2. Descarga y combina todos
3. Aplica limpieza
4. Guarda en Silver
5. Elimina versiones antiguas (REPLACE)</p><p>---</p><p><h2>ğŸ’¾ Capa Bronce</h2></p><p><h3>Contenido</h3>
<ul><li>Archivos CSV sin procesar</li></ul>
<ul><li>Datos tal como salen de PostgreSQL</li></ul>
<ul><li>Uno por cada extracciÃ³n incremental</li></ul>
<ul><li>Formato: <code>tabla<em>bronce</em>YYYYMMDDHHMMSS.csv</code></li></ul></p><p><h3>Estructura en MinIO</h3></p><p><code></code>`
meteo-bronze/
â”œâ”€â”€ sensor_readings/
â”‚   â”œâ”€â”€ sensor<em>readings</em>bronce_20251203093625.csv  (97 filas)
â”‚   â””â”€â”€ sensor<em>readings</em>bronce_20251203100123.csv  (45 filas)
â”œâ”€â”€ estaciones/
â”‚   â””â”€â”€ estaciones<em>bronce</em>20251203093625.csv  (50 filas)
â””â”€â”€ [otras tablas]/
<code></code>`</p><p><h3>CaracterÃ­sticas</h3>
<ul><li>âŒ Sin deduplicaciÃ³n</li></ul>
<ul><li>âŒ Con outliers</li></ul>
<ul><li>âŒ Columnas redundantes</li></ul>
<ul><li>âœ… HistÃ³rico completo disponible</li></ul></p><p>---</p><p><h2>ğŸ§¹ Capa Silver</h2></p><p><h3>Contenido</h3>
<ul><li>Archivos CSV limpios y consolidados</li></ul>
<ul><li><strong>Un Ãºnico archivo por tabla</strong> (estrategia REPLACE)</li></ul>
<ul><li>Datos combinados de todas las extracciones</li></ul>
<ul><li>Formato: <code>tabla<em>silver</em>YYYYMMDDHHMMSS.csv</code></li></ul></p><p><h3>Estructura en MinIO</h3></p><p><code></code>`
meteo-silver/
â”œâ”€â”€ sensor_readings/
â”‚   â””â”€â”€ sensor<em>readings</em>silver_20251203094013.csv  (97 filas limpias)
â”œâ”€â”€ estaciones/
â”‚   â””â”€â”€ estaciones<em>silver</em>20251203094013.csv  (50 filas limpias)
â””â”€â”€ [otras tablas]/
<code></code>`</p><p><h3>CaracterÃ­sticas</h3>
<ul><li>âœ… Sin duplicados</li></ul>
<ul><li>âœ… Outliers reemplazados con mediana</li></ul>
<ul><li>âœ… Columnas innecesarias eliminadas</li></ul>
<ul><li>âœ… Valores en rangos vÃ¡lidos</li></ul>
<ul><li>âœ… <strong>Un Ãºnico archivo consolidado</strong></li></ul></p><p>---</p><p><h2>ğŸ§¹ Limpieza AutomÃ¡tica</h2></p><p><h3>Operaciones de Limpieza</h3></p><p><h4>1. EliminaciÃ³n de Duplicados</h4>
<code></code>`
Antes:  100 filas
DespuÃ©s: 100 filas (ejemplo sin duplicados)
<code></code>`</p><p><h4>2. Reemplazo de Outliers (MÃ©todo IQR)</h4>
<code></code>`
Temperatura normal: 10Â°C - 50Â°C
CÃ¡lculo:
  Q1 = Percentil 25
  Q3 = Percentil 75
  IQR = Q3 - Q1
  LÃ­mite inferior = Q1 - 1.5 Ã— IQR
  LÃ­mite superior = Q3 + 1.5 Ã— IQR
  
Outliers detectados: 13
AcciÃ³n: Reemplazar con mediana (24.00Â°C)
<code></code>`</p><p><h4>3. EliminaciÃ³n de Columnas</h4>
<code></code>`
Columnas eliminadas:
<ul><li>uv_level</li></ul>
<ul><li>vibration</li></ul>
<ul><li>rain_raw</li></ul>
<ul><li>wind_raw</li></ul>
<ul><li>pressure</li></ul>
<code></code>`</p><p><h4>4. Filtrado de Rangos</h4>
<code></code>`
Temperatura: 10Â°C - 50Â°C
Humedad: 0% - 100%
<code></code>`</p><p><h3>Estrategia REPLACE</h3></p><p><strong>Problema:</strong> Â¿QuÃ© pasa si se ejecuta mÃºltiples veces?</p><p><strong>SoluciÃ³n:</strong> REPLACE automÃ¡tico</p><p><code></code>`
CICLO 1 (09:00): Extrae 100 registros
  â†’ Bronce: archivo #1 (100 filas)
  â†’ Silver: sensor<em>readings</em>silver<em>20251203</em>090000.csv (100 limpias)</p><p>CICLO 2 (09:05): Extrae 50 nuevos registros
  â†’ Bronce: archivo #2 (50 filas)
  â†’ Combina Bronce #1 + #2 = 150 filas
  â†’ Silver: sensor<em>readings</em>silver<em>20251203</em>090500.csv (150 limpias)
  â†’ âŒ Elimina versiÃ³n anterior
  â†’ âœ… Mantiene solo la mÃ¡s reciente</p><p>CICLO 3 (09:10): Extrae 30 nuevos registros
  â†’ Bronce: archivo #3 (30 filas)
  â†’ Combina Bronce #1 + #2 + #3 = 180 filas
  â†’ Silver: sensor<em>readings</em>silver<em>20251203</em>091000.csv (180 limpias)
  â†’ âŒ Elimina versiÃ³n anterior
  â†’ âœ… Mantiene solo la mÃ¡s reciente
<code></code>`</p><p><strong>Ventajas:</strong>
<ul><li>âœ… Dataset actualizado constantemente</li></ul>
<ul><li>âœ… Archivo no crece indefinidamente</li></ul>
<ul><li>âœ… Espacio controlado en MinIO</li></ul>
<ul><li>âœ… Totalmente automÃ¡tico</li></ul>
<ul><li>âœ… Sin intervenciÃ³n manual</li></ul></p><p>---</p><p><h2>ğŸ” VerificaciÃ³n de Datos</h2></p><p><h3>Ver archivos en MinIO</h3>
<code></code>`bash
mc ls myminio/meteo-bronze/sensor_readings/
mc ls myminio/meteo-silver/sensor_readings/
<code></code>`</p><p><h3>Descargar archivo</h3>
<code></code>`bash
mc cp myminio/meteo-silver/sensor<em>readings/sensor</em>readings_silver*.csv ./
<code></code>`</p><p><h3>Leer con Pandas</h3>
<code></code>`python
import pandas as pd</p><p>df = pd.read<em>csv('sensor</em>readings<em>silver</em>20251203_094013.csv')
print(f"Filas: {len(df)}")
print(f"Columnas: {len(df.columns)}")
print(df.head())
<code></code>`</p><p><h3>Ver estado de extracciones</h3>
<code></code>`python
from etl.etl_state import StateManager</p><p>manager = StateManager()
manager.display_state()
<code></code>`</p><p>---</p><p><h2>ğŸ› ï¸ SoluciÃ³n de Problemas</h2></p><p><h3>Error: "No connection to PostgreSQL"</h3>
<code></code>`powershell
<h1>Verificar credenciales</h1>
$env:PG_HOST = "10.202.50.50"
$env:PG_USER = "postgres"
$env:PG_PASS = "1234"</p><p><h1>Probar conexiÃ³n</h1>
psql -h 10.202.50.50 -U postgres -d postgres -c "SELECT 1"
<code></code>`</p><p><h3>Error: "MinIO connection refused"</h3>
<code></code>`bash
<h1>Verificar que MinIO estÃ¡ ejecutÃ¡ndose</h1>
curl http://localhost:9000</p><p><h1>Configurar alias</h1>
mc alias set myminio http://localhost:9000 minioadmin minioadmin
mc ls myminio
<code></code>`</p><p><h3>Error: "Columna de rastreo no detectada"</h3>
Editar en <code>etl/extractors/table_inspector.py</code>:
<code></code>`python
TIMESTAMP<em>COLUMNS = ['created</em>at', 'updated<em>at', 'timestamp', 'fecha', 'tu</em>columna']
<code></code>`</p><p><h3>No se generan archivos en Silver</h3>
1. Verificar que hay datos en Bronce
2. Revisar logs de <code>DataCleaner</code>
3. Ejecutar manualmente: <code>cleaner.clean<em>table("sensor</em>readings")</code></p><p><h3>Archivos viejos se acumulan en Silver</h3>
<ul><li>Verificar que <code><em>manage</em>versions()</code> se ejecuta</li></ul>
<ul><li>Ver logs de "Eliminado:"</li></ul>
<ul><li>El REPLACE debe ocurrir automÃ¡ticamente</li></ul></p><p>---</p><p><h2>ğŸ“Š EstadÃ­sticas de Ejemplo</h2></p><p><code></code>`
Sistema Ejecutado: 3 ciclos
PerÃ­odo: 09:00 - 09:10 (10 minutos)</p><p>BRONCE:
  sensor_readings: 3 archivos, 175 filas totales
  estaciones: 1 archivo, 50 filas
  
SILVER:
  sensor_readings: 1 archivo (REPLACE activo), 175 limpias
  estaciones: 1 archivo (REPLACE activo), 50 limpias</p><p>Limpieza:
  Duplicados eliminados: 0
  Outliers corregidos: 28
  Columnas eliminadas: 5
  RetenciÃ³n: 99.3%
<code></code>`</p><p>---</p><p><h2>ğŸ“– DocumentaciÃ³n Adicional</h2></p><p><ul><li><strong>MIGRACION<em>STATE</em>MANAGEMENT.md</strong>: GestiÃ³n de estado JSON</li></ul>
<ul><li><strong>ANALISIS<em>LIMPIEZA</em>CODIGO.md</strong>: CÃ³digo eliminado durante refactorizaciÃ³n</li></ul>
<ul><li><strong>ESTADO<em>FINAL</em>LIMPIEZA.md</strong>: Estado actual del proyecto</li></ul></p><p>---</p><p><strong>Ãšltima actualizaciÃ³n:</strong> 3 de Diciembre de 2025  
<strong>VersiÃ³n:</strong> 3.0 (Con Limpieza AutomÃ¡tica)  
<strong>Estado:</strong> âœ… ProducciÃ³n</p><p>
---</p><p><h2>ğŸ“‹ DescripciÃ³n General</h2></p><p>Este proyecto implementa un <strong>pipeline ETL modular orientado a objetos</strong> que:</p><p>âœ… Extrae <strong>solo registros nuevos</strong> de todas las tablas de PostgreSQL  
âœ… Detecta automÃ¡ticamente <strong>Primary Keys</strong> o columnas de rastreo  
âœ… <strong>Valida datos nuevos</strong> antes de procesar  
âœ… Guarda datos en formato <strong>CSV</strong> (Bronce) y <strong>Parquet</strong> (Silver)  
âœ… Sube archivos a <strong>MinIO</strong> (almacenamiento objeto compatible S3)  
âœ… Mantiene un <strong>control de estado</strong> para evitar duplicados  
âœ… Ejecuta automÃ¡ticamente cada 5 minutos (configurable)  
âœ… <strong>CÃ³digo modular</strong>: cada componente en su propio archivo  
âœ… <strong>FÃ¡cil mantenimiento</strong>: estructura clara con type hints  </p><p>---</p><p><h2>ğŸ—ï¸ Arquitectura</h2></p><p><h3>Sistema de Capas</h3></p><p><code></code>`
PostgreSQL (Origen)
    â†“
[ETLPipeline] â†’ ExtracciÃ³n incremental
    â†“
Archivos CSV (/tmp)
    â†“
MinIO Capa BRONCE (Raw Data)
    â†“
[Limpieza & TransformaciÃ³n]
    â†“
MinIO Capa SILVER (Datos Limpios)
<code></code>`</p><p><h3>Componentes del Sistema</h3></p><p><code></code>`
pruebaMeteorologica/
â”œâ”€â”€ main.py                          # ğŸš€ Punto de entrada principal
â”œâ”€â”€ run_scheduler.ps1                # Script PowerShell (Windows)
â”œâ”€â”€ run_scheduler.sh                 # Script Bash (Linux)
â”œâ”€â”€ DOCUMENTACION.md                 # ğŸ“– DocumentaciÃ³n completa
â”‚
â”œâ”€â”€ config/                          # ğŸ“ Configuraciones
â”‚   â”œâ”€â”€ <strong>init</strong>.py
â”‚   â”œâ”€â”€ database_config.py          # ConfiguraciÃ³n PostgreSQL
â”‚   â””â”€â”€ minio_config.py             # ConfiguraciÃ³n MinIO
â”‚
â”œâ”€â”€ etl/                             # ğŸ”§ Componentes del pipeline
â”‚   â”œâ”€â”€ <strong>init</strong>.py
â”‚   â”œâ”€â”€ db_utils.py                 # Utilidades BD centralizadas (NEW)
â”‚   â”œâ”€â”€ control_manager.py          # GestiÃ³n de tabla de control
â”‚   â”œâ”€â”€ table_inspector.py          # InspecciÃ³n de estructura de tablas
â”‚   â”œâ”€â”€ data_extractor.py           # ExtracciÃ³n incremental
â”‚   â”œâ”€â”€ parquet_writer.py           # Escritura de archivos Parquet
â”‚   â”œâ”€â”€ minio_uploader.py           # Subida a MinIO
â”‚   â”œâ”€â”€ table_processor.py          # Procesamiento de tabla individual
â”‚   â”œâ”€â”€ limpieza_bronce.py          # Limpieza automÃ¡tica
â”‚   â”œâ”€â”€ silver_layer.py             # TransformaciÃ³n Silver
â”‚   â””â”€â”€ pipeline.py                 # Pipeline completo
â”‚
â”œâ”€â”€ notebooks/                       # ğŸ“Š Notebooks Jupyter
â”‚   â””â”€â”€ templates/
â”‚       â””â”€â”€ limpieza_template.ipynb  # Limpieza manual (alternativa)
â”‚
â””â”€â”€ venv_meteo/                      # Entorno virtual Python
<code></code>`</p><p>---</p><p><h2>ğŸš€ InstalaciÃ³n y ConfiguraciÃ³n</h2></p><p><h3>1. Requisitos Previos</h3></p><p><ul><li><strong>Python 3.8+</strong></li></ul>
<ul><li><strong>PostgreSQL</strong> corriendo con tablas a procesar</li></ul>
<ul><li><strong>MinIO</strong> instalado y configurado (servidor + cliente <code>mc</code>)</li></ul>
<ul><li><strong>PySpark</strong> (opcional, para silver_layer)</li></ul></p><p><h3>2. Instalar Dependencias</h3></p><p><code></code>`powershell
<h1>Entorno virtual</h1>
python -m venv venv_meteo
.\venv_meteo\Scripts\Activate</p><p><h1>Dependencias</h1>
pip install pandas sqlalchemy psycopg2-binary pyarrow minio
<code></code>`</p><p><h3>3. Configurar Variables de Entorno</h3></p><p><strong>Archivo: <code>run_scheduler.ps1</code> (Windows)</strong>
<code></code>`powershell
<h1>PostgreSQL</h1>
$env:PG_HOST = "10.202.50.50"       # IP o localhost
$env:PG_USER = "postgres"           # Usuario
$env:PG_PASS = "1234"               # ContraseÃ±a
$env:PG_DB = "postgres"             # Base de datos</p><p><h1>MinIO</h1>
$env:MINIO_ENDPOINT = "localhost:9000"      # IP:puerto
$env:MINIO<em>ACCESS</em>KEY = "minioadmin"        # Acceso
$env:MINIO<em>SECRET</em>KEY = "minioadmin"        # Secreto
$env:MINIO_BUCKET = "meteo-bronze"         # Bucket
<code></code>`</p><p><strong>Archivo: <code>run_scheduler.sh</code> (Linux)</strong>
<code></code>`bash
export PG_HOST="10.202.50.50"
export PG_USER="postgres"
export PG_PASS="1234"
export PG_DB="postgres"</p><p>export MINIO_ENDPOINT="localhost:9000"
export MINIO<em>ACCESS</em>KEY="minioadmin"
export MINIO<em>SECRET</em>KEY="minioadmin"
export MINIO_BUCKET="meteo-bronze"
<code></code>`</p><p><h3>4. Configurar MinIO</h3></p><p><code></code>`bash
<h1>Configurar alias</h1>
mc alias set myminio http://localhost:9000 minioadmin minioadmin</p><p><h1>Crear buckets</h1>
mc mb myminio/meteo-bronze
mc mb myminio/meteo-silver</p><p><h1>Verificar</h1>
mc ls myminio
<code></code>`</p><p>---</p><p><h2>â–¶ï¸ Uso</h2></p><p><h3>OpciÃ³n 1: EjecuciÃ³n Manual Completa (RECOMENDADO)</h3></p><p><code></code>`powershell
<h1>Terminal PowerShell</h1>
cd c:\Users\Alumno<em>AI\Desktop\Estacion</em>Meteorologica</p><p><h1>Configurar variables</h1>
$env:PG_DB='postgres'
$env:PG_USER='postgres'
$env:PG_PASS='1234'
$env:PG_HOST='10.202.50.50'
$env:MINIO_ENDPOINT='localhost:9000'
$env:MINIO<em>ACCESS</em>KEY='minioadmin'
$env:MINIO<em>SECRET</em>KEY='minioadmin'
$env:MINIO_BUCKET='meteo-bronze'</p><p><h1>Ejecutar (ciclo continuo: extrae + limpia)</h1>
.\venv_meteo\Scripts\python.exe main.py</p><p><h1>Presionar Ctrl+C para detener</h1>
<code></code>`</p><p><strong>Ciclo cada 5 minutos:</strong>
<code></code>`
1. Extrae datos de PostgreSQL â†’ Bronce (CSV)
2. Limpia automÃ¡ticamente â†’ Silver (Parquet)
3. Espera 5 minutos
4. Repite
<code></code>`</p><p><h3>OpciÃ³n 2: Limpieza Manual</h3></p><p><code></code>`powershell
<h1>Solo limpiar datos existentes en Bronce</h1>
.\venv<em>meteo\Scripts\python.exe limpiar</em>bronce.py
<code></code>`</p><p><h3>OpciÃ³n 3: Notebook Interactivo</h3></p><p><code></code>`
1. Abrir: notebooks/templates/limpieza_template.ipynb
2. Ejecutar celdas 1-19 (configuraciÃ³n)
3. Ejecutar celda 20 (limpieza)
4. Datos guardados en Silver
<code></code>`</p><p>---</p><p><h2>ğŸ”§ Estructura del CÃ³digo</h2></p><p><h3>Configuraciones (<code>config/</code>)</h3></p><p><h4><strong>DatabaseConfig</strong> (database_config.py)</h4>
<code></code>`python
<h1>Encapsula configuraciÃ³n de PostgreSQL</h1>
config = DatabaseConfig()
connection<em>url = config.connection</em>url  # postgresql://...
<code></code>`</p><p><strong>Propiedades:</strong>
<ul><li><code>user</code>: Usuario PostgreSQL</li></ul>
<ul><li><code>password</code>: ContraseÃ±a</li></ul>
<ul><li><code>host</code>: IP servidor</li></ul>
<ul><li><code>database</code>: Base de datos</li></ul>
<ul><li><code>connection_url</code>: URL formateada</li></ul></p><p><h4><strong>MinIOConfig</strong> (minio_config.py)</h4>
<code></code>`python
<h1>Encapsula configuraciÃ³n de MinIO</h1>
config = MinIOConfig()
bucket = config.bucket  # meteo-bronze
silver<em>bucket = config.silver</em>bucket  # meteo-silver
<code></code>`</p><p>---</p><p><h3>Pipeline ETL (<code>etl/</code>)</h3></p><p><h4><strong>1. ETLControlManager</strong> (control_manager.py)</h4>
Rastrea el estado de extracciÃ³n de cada tabla.</p><p><code></code>`python
manager = ETLControlManager(connection)
last<em>value = manager.get</em>last<em>extracted</em>value("sensor_readings")
manager.update<em>last</em>extracted<em>value("sensor</em>readings", 100, "id")
<code></code>`</p><p><strong>Tabla de control:</strong>
<code></code>`sql
CREATE TABLE etl_control (
    table_name VARCHAR(255) PRIMARY KEY,
    last<em>extracted</em>value VARCHAR(255),
    last<em>extracted</em>at TIMESTAMP,
    tracking_column VARCHAR(255)
)
<code></code>`</p><p><h4><strong>2. TableInspector</strong> (table_inspector.py)</h4>
Inspecciona estructura de tablas.</p><p><code></code>`python
inspector = TableInspector(connection)
tables = inspector.get<em>all</em>tables()
columns = inspector.get<em>columns("sensor</em>readings")
tracking<em>col = inspector.detect</em>tracking<em>column("sensor</em>readings")
<code></code>`</p><p><strong>DetecciÃ³n de columna de rastreo (orden de prioridad):</strong>
1. Timestamp: <code>created<em>at</code>, <code>updated</em>at</code>, <code>timestamp</code>
2. PRIMARY KEY numÃ©rico
3. Columna <code>id</code> genÃ©rica</p><p><h4><strong>3. DataExtractor</strong> (data_extractor.py)</h4>
Extrae datos incrementales.</p><p><code></code>`python
extractor = DataExtractor(connection, "sensor_readings")
df = extractor.extract<em>incremental(last</em>value=100)
<code></code>`</p><p><strong>LÃ³gica:</strong>
<ul><li>Si <code>last<em>value</code> existe: <code>SELECT * WHERE columna > last</em>value</code></li></ul>
<ul><li>Si primera carga: <code>SELECT * FROM tabla</code></li></ul></p><p><h4><strong>4. ParquetWriter</strong> (parquet_writer.py)</h4>
Escriba archivos Parquet.</p><p><code></code>`python
writer = ParquetWriter()
writer.write(df, "output.parquet")
<code></code>`</p><p><strong>Estrategia Pattern:</strong> FÃ¡cil agregar CSVWriter, JSONWriter, etc.</p><p><h4><strong>5. MinIOUploader</strong> (minio_uploader.py)</h4>
Sube archivos a MinIO.</p><p><code></code>`python
uploader = MinIOUploader(config)
uploader.upload("local<em>file.parquet", "sensor</em>readings", "file_name.parquet")
<code></code>`</p><p><h4><strong>6. TableProcessor</strong> (table_processor.py)</h4>
Orquesta procesamiento completo de una tabla.</p><p><code></code>`python
processor = TableProcessor(connection, config)
records<em>count = processor.process("sensor</em>readings")  # Retorna cantidad
<code></code>`</p><p><strong>Flujo:</strong>
1. Detecta columna rastreo
2. Obtiene Ãºltimo valor procesado
3. Extrae datos nuevos
4. Guarda en Parquet
5. Sube a MinIO
6. Actualiza control</p><p><h4><strong>7. ETLPipeline</strong> (pipeline.py)</h4>
Pipeline principal que coordina todo.</p><p><code></code>`python
pipeline = ETLPipeline(config)
pipeline.process_batch()  # Procesa una ronda
pipeline.run<em>continuous(interval</em>seconds=300)  # Bucle infinito (5 min)
<code></code>`</p><p><h4><strong>8. Limpieza (limpieza_bronce.py)</strong></h4>
Limpieza de datos automÃ¡tica.</p><p><code></code>`python
cleaner = LimpiezaBronce(config)
cleaner.procesar<em>tabla("sensor</em>readings")
<code></code>`</p><p><strong>Operaciones:</strong>
<ul><li>Elimina duplicados</li></ul>
<ul><li>Reemplaza outliers con mediana (IQR)</li></ul>
<ul><li>Elimina columnas innecesarias</li></ul>
<ul><li>Filtra valores invÃ¡lidos</li></ul></p><p><h4><strong>9. SilverLayer</strong> (silver_layer.py)</h4>
TransformaciÃ³n de Bronce a Silver.</p><p><code></code>`python
silver = SilverLayer(config)
exito = silver.process("sensor_readings")  # Booleano
<code></code>`</p><p><strong>PatrÃ³n Strategy para limpieza:</strong>
<ul><li><code>DataCleaner</code> (clase abstracta)</li></ul>
<ul><li><code>SensorReadingsCleaner</code> (implementaciÃ³n especÃ­fica)</li></ul>
<ul><li>FÃ¡cil extender con nuevas limpiadoras</li></ul></p><p><h4><strong>10. DatabaseUtils</strong> (db_utils.py - NUEVO)</h4>
Centraliza operaciones de base de datos.</p><p><code></code>`python
<h1>Queries reutilizables</h1>
result = DatabaseUtils.fetch_one(connection, query, params)
rows = DatabaseUtils.fetch_all(connection, query)
DatabaseUtils.execute(connection, query, params)
<code></code>`</p><p><strong>Clases:</strong>
<ul><li><code>DatabaseUtils</code>: MÃ©todos estÃ¡ticos para ejecutar queries</li></ul>
<ul><li><code>TableQueryBuilder</code>: Constructor de queries</li></ul></p><p>---</p><p><h2>ğŸ¯ RefactorizaciÃ³n OOP</h2></p><p><h3>CaracterÃ­sticas de DiseÃ±o</h3></p><p>âœ… <strong>SeparaciÃ³n de responsabilidades</strong>: Cada clase, una funciÃ³n  
âœ… <strong>Type hints</strong>: 100% cobertura de tipos  
âœ… <strong>Patrones de diseÃ±o</strong>: Strategy, Factory, Builder  
âœ… <strong>SOLID principles</strong>: Todos implementados  
âœ… <strong>AbstracciÃ³n</strong>: Clases base (Config, DataCleaner)  
âœ… <strong>Modularidad</strong>: Componentes reutilizables  </p><p><h3>Clases Base (Herencia)</h3></p><p><code></code>`python
<h1>Base de configuraciones</h1>
class Config:
    @staticmethod
    def get_env(key: str, default: Optional[str] = None) -> str:
        value = os.environ.get(key, default)
        if value is None:
            raise ValueError(f"Variable requerida: {key}")
        return value</p><p><h1>DatabaseConfig hereda de Config</h1>
class DatabaseConfig(Config):
    def <strong>init</strong>(self, user: Optional[str] = None, ...):
        self.user = user or self.get<em>env('PG</em>USER', 'postgres')
<code></code>`</p><p><h3>PatrÃ³n Strategy (Limpieza)</h3></p><p><code></code>`python
from abc import ABC, abstractmethod</p><p>class DataCleaner(ABC):
    @abstractmethod
    def clean(self, df: DataFrame) -> DataFrame:
        pass</p><p>class SensorReadingsCleaner(DataCleaner):
    def clean(self, df: DataFrame) -> DataFrame:
        df = self.<em>remove</em>duplicates(df)
        df = self.<em>replace</em>outliers(df, "temperature")
        df = self.<em>drop</em>unnecessary_columns(df)
        return df</p><p><h1>Usar</h1>
CLEANERS = {"sensor_readings": SensorReadingsCleaner()}
<code></code>`</p><p><h3>Type Hints Completos</h3></p><p><code></code>`python
def process(self, table_name: str) -> bool:
    """Procesa una tabla.
    
    Args:
        table_name: Nombre de la tabla
        
    Returns:
        bool: True si Ã©xito, False si error
    """
    pass
<code></code>`</p><p>---</p><p><h2>ğŸ“Š Procesamiento de Datos</h2></p><p><h3>Capa Bronce (Bronze)</h3>
<ul><li><strong>Tipo</strong>: CSV</li></ul>
<ul><li><strong>Contenido</strong>: Datos sin procesar</li></ul>
<ul><li><strong>CaracterÃ­sticas</strong>:</li></ul>
  <li style="margin-left: 40px;">Contiene duplicados</li>
  <li style="margin-left: 40px;">Contiene outliers</li>
  <li style="margin-left: 40px;">Columnas redundantes</li></p><p><h3>Capa Silver (Silver)</h3>
<ul><li><strong>Tipo</strong>: CSV</li></ul>
<ul><li><strong>Contenido</strong>: Datos procesados</li></ul>
<ul><li><strong>CaracterÃ­sticas</strong>:</li></ul>
  <li style="margin-left: 40px;">Sin duplicados</li>
  <li style="margin-left: 40px;">Outliers reemplazados con mediana</li>
  <li style="margin-left: 40px;">Solo columnas relevantes</li>
<ul><li><strong>Estrategia</strong>: <strong>REPLACE</strong> - Solo mantiene el dataset mÃ¡s reciente</li></ul></p><p><h3>Operaciones de Limpieza (sensor_readings)</h3></p><p>1. <strong>Eliminar duplicados</strong>
   <code></code>`python
   df = df.distinct()  # Spark: elimina filas idÃ©nticas
   <code></code>`</p><p>2. <strong>Reemplazar outliers</strong> (IQR method)
   <code></code>`
   Q1 = percentil 25
   Q3 = percentil 75
   IQR = Q3 - Q1
   Limites = [Q1 - 1.5<em>IQR, Q3 + 1.5</em>IQR]
   Outliers: reemplazar con mediana
   <code></code>`</p><p>3. <strong>Eliminar columnas</strong>
   <code></code>`
   uv<em>level, vibration, rain</em>raw, wind_raw, pressure
   <code></code>`</p><p>4. <strong>Filtrar valores invÃ¡lidos</strong>
   <code></code>`
   temperature: 10Â°C - 50Â°C
   humidity: 0% - 100%
   <code></code>`</p><p><h3>ğŸ”„ Estrategia REPLACE: GestiÃ³n de Versiones</h3></p><p><strong>Problema:</strong> Si extraes mÃºltiples veces, Â¿cÃ³mo evitar acumular archivos?</p><p><strong>SoluciÃ³n:</strong> Estrategia REPLACE automÃ¡tica</p><p><code></code>`
CICLO 1 (09:00):
  âœ… Extrae 100 filas â†’ Bronce CSV #1
  âœ… Limpia â†’ Silver: sensor<em>readings</em>silver<em>20251202</em>090000.csv (100 filas)</p><p>CICLO 2 (09:05):
  âœ… Extrae 50 filas â†’ Bronce CSV #2
  âœ… Combina CSV #1 + #2 = 150 filas (sin duplicados)
  âœ… Limpia â†’ Silver: sensor<em>readings</em>silver<em>20251202</em>090500.csv (150 filas)
  âœ… Elimina automÃ¡ticamente versiÃ³n anterior</p><p>CICLO 3 (09:10):
  âœ… Extrae 30 filas â†’ Bronce CSV #3
  âœ… Combina todos = 180 filas (sin duplicados)
  âœ… Limpia â†’ Silver: sensor<em>readings</em>silver<em>20251202</em>091000.csv (180 filas)
  âœ… Elimina automÃ¡ticamente versiÃ³n anterior
<code></code>`</p><p><strong>Ventajas:</strong>
<ul><li>âœ… Siempre tienes el dataset mÃ¡s reciente</li></ul>
<ul><li>âœ… El archivo NO crece indefinidamente</li></ul>
<ul><li>âœ… Espacio en MinIO controlado y predecible</li></ul>
<ul><li>âœ… Proceso automÃ¡tico, sin intervenciÃ³n manual</li></ul></p><p><strong>CÃ³mo funciona:</strong>
1. Se guarda nuevo CSV en Silver con timestamp
2. El mÃ³dulo <code>SilverManager</code> detecta versiones antiguas
3. AutomÃ¡ticamente elimina todas EXCEPTO la mÃ¡s reciente
4. Solo un archivo activo por tabla en Silver</p><p>---</p><p><h2>ğŸ“‚ Estructura de Archivos en MinIO</h2></p><p><h3>Bronce (meteo-bronze)</h3>
<code></code>`
meteo-bronze/
â”œâ”€â”€ sensor_readings/
â”‚   â”œâ”€â”€ sensor<em>readings</em>bronce<em>20251202</em>091647.csv  (97 filas)
â”‚   â””â”€â”€ sensor<em>readings</em>bronce<em>20251202</em>101823.csv  (30 filas)
â”œâ”€â”€ weather/
â”‚   â””â”€â”€ weather<em>bronce</em>20251202_091647.csv  (50 filas)
â””â”€â”€ [otras tablas]/
    â””â”€â”€ ...
<code></code>`</p><p><h3>Silver (meteo-silver)</h3>
<code></code>`
meteo-silver/
â”œâ”€â”€ sensor_readings/
â”‚   â”œâ”€â”€ sensor<em>readings</em>silver<em>20251202</em>130210.csv  (127 filas limpias)
â”‚   â””â”€â”€ sensor<em>readings</em>silver<em>20251202</em>140521.csv  (55 filas limpias)
â”œâ”€â”€ weather/
â”‚   â””â”€â”€ weather<em>silver</em>20251202_130210.csv  (48 filas limpias)
â””â”€â”€ [otras tablas]/
    â””â”€â”€ ...
<code></code>`</p><p>---</p><p><h2>ğŸ” VerificaciÃ³n de Datos</h2></p><p><h3>Ver archivos en MinIO</h3>
<code></code>`bash
mc ls myminio/meteo-bronze/
mc ls myminio/meteo-bronze/sensor_readings/
<code></code>`</p><p><h3>Descargar archivo</h3>
<code></code>`bash
mc cp myminio/meteo-bronze/sensor<em>readings/sensor</em>readings<em>bronce</em>*.csv ./
<code></code>`</p><p><h3>Leer con Python</h3>
<code></code>`python
import pandas as pd</p><p>df = pd.read<em>csv('sensor</em>readings<em>bronce</em>20251202_091647.csv')
print(f"Filas: {len(df)}")
print(df.head())
<code></code>`</p><p><h3>Consultar tabla de control</h3>
<code></code>`sql
SELECT * FROM etl_control;
<code></code>`</p><p><strong>Resultado esperado:</strong>
<code></code>`
table<em>name     <td>last</em>extracted<em>value</td> last</em>extracted<em>at  | tracking</em>column
---------------|----------------------|--------------------|-----------------
sensor_readings<td>1000                </td> 2025-12-02 13:02   | id
weather        <td>500                 </td> 2025-12-02 13:01   | measurement_id
<code></code>`</p><p>---</p><p><h2>ğŸ› ï¸ SoluciÃ³n de Problemas</h2></p><p><h3>Error: "El cliente 'mc' no estÃ¡ instalado"</h3>
<code></code>`bash
wget https://dl.min.io/client/mc/release/linux-amd64/mc
chmod +x mc
sudo mv mc /usr/local/bin/
<code></code>`</p><p><h3>Error: "Connection refused" en PostgreSQL</h3>
<code></code>`powershell
<h1>Verificar credenciales</h1>
psql -h 10.202.50.50 -U postgres -d postgres</p><p><h1>Verificar variables de entorno</h1>
echo $env:PG_HOST
echo $env:PG_USER
<code></code>`</p><p><h3>Error: "FallÃ³ la carga a MinIO"</h3>
<code></code>`bash
<h1>Verificar alias</h1>
mc alias list
mc alias set myminio http://localhost:9000 minioadmin minioadmin</p><p><h1>Verificar conectividad</h1>
mc ls myminio
<code></code>`</p><p><h3>Error: "Table etl_control not found"</h3>
El sistema crea la tabla automÃ¡ticamente en la primera ejecuciÃ³n. Si no se crea:
<code></code>`sql
CREATE TABLE etl_control (
    table_name VARCHAR(255) PRIMARY KEY,
    last<em>extracted</em>value VARCHAR(255),
    last<em>extracted</em>at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    tracking_column VARCHAR(255)
)
<code></code>`</p><p><h3>No detecta columna de rastreo</h3>
Editar en <code>etl/table_inspector.py</code>:
<code></code>`python
<h1>Agregar candidatos personalizados</h1>
timestamp<em>candidates = ['created</em>at', 'updated<em>at', 'fecha', 'date', 'tu</em>columna']
<code></code>`</p><p>---</p><p><h2>ğŸ“ˆ Ejemplo de EjecuciÃ³n Completa</h2></p><p><code></code>`
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸš€ Iniciando Sistema ETL Incremental
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š Base de datos: postgres@10.202.50.50
ğŸ—„ï¸  MinIO Bucket: meteo-bronze
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</p><p>--- INICIO DE BATCH: 2025-12-02 09:16:47 ---</p><p>Procesando tabla: sensor_readings
   ğŸ“Š Detectada columna: id (numÃ©rica)
   ğŸ” Ãšltimo valor: 900
   ğŸ“¦ Registros nuevos: 97
   ğŸ’¾ Guardando: sensor<em>readings</em>bronce<em>20251202</em>091647.csv
   âœ… Subido a Bronce
   ğŸ§¹ Limpiando...
   âœ… Duplicados eliminados: 97 â†’ 97
   âœ… Outliers reemplazados: 2
   âœ… Columnas eliminadas: 5
   âœ… Subido a Silver: sensor<em>readings</em>silver<em>20251202</em>091647.csv</p><p>Procesando tabla: weather
   ğŸ“Š Detectada columna: created_at (timestamp)
   ğŸ” Ãšltimo valor: 2025-12-02 08:00:00
   ğŸ“¦ Registros nuevos: 50
   ğŸ’¾ Guardando: weather<em>bronce</em>20251202_091647.csv
   âœ… Subido a Bronce
   ğŸ§¹ Limpiando...
   âœ… Duplicados eliminados: 50 â†’ 50
   âœ… Outliers reemplazados: 1
   âœ… Subido a Silver: weather<em>silver</em>20251202_091647.csv</p><p>ğŸ¯ RESUMEN: 147 registros nuevos en este batch.
â° PrÃ³xima ejecuciÃ³n: 09:21:47 (en 5 minutos)
<code></code>`</p><p>---</p><p><h2>ğŸ“ PrÃ³ximos Pasos</h2></p><p><ul><li>[ ] Agregar pruebas unitarias</li></ul>
<ul><li>[ ] Implementar logging estructura (logging module)</li></ul>
<ul><li>[ ] Agregar mÃ©tricas y monitoreo</li></ul>
<ul><li>[ ] Crear CLI para administraciÃ³n</li></ul>
<ul><li>[ ] Implementar re-intentos automÃ¡ticos</li></ul>
<ul><li>[ ] Agregar alertas por errores</li></ul></p><p>---</p><p><h2>ğŸ‘¤ InformaciÃ³n del Proyecto</h2></p><p><ul><li><strong>Tipo</strong>: Data Lake ETL</li></ul>
<ul><li><strong>Arquitectura</strong>: Modular, OOP, SOLID</li></ul>
<ul><li><strong>Lenguaje</strong>: Python 3.8+</li></ul>
<ul><li><strong>Frameworks</strong>: SQLAlchemy, Pandas, PySpark, MinIO</li></ul>
<ul><li><strong>Bases de datos</strong>: PostgreSQL, MinIO (Object Storage)</li></ul></p><p>---</p><p><h2>ğŸ“– DocumentaciÃ³n TÃ©cnica</h2></p><p>Este archivo consolida toda la documentaciÃ³n tÃ©cnica del proyecto. Todos los componentes estÃ¡n documentados con:
<ul><li>Type hints completos</li></ul>
<ul><li>Docstrings en mÃ©todos</li></ul>
<ul><li>Ejemplos de uso</li></ul>
<ul><li>Configuraciones recomendadas</li></ul></p><p>Para preguntas especÃ­ficas sobre componentes individuales, consultar los archivos en <code>etl/</code> y <code>config/</code>.</p><p>---</p><p><strong>Ãšltima actualizaciÃ³n:</strong> 2 de Diciembre de 2025  
<strong>VersiÃ³n:</strong> 2.0 (RefactorizaciÃ³n OOP Completa)
</p>
        </article>
    </main>

    <footer>
        <p>&copy; 2025 EstaciÃ³n MeteorolÃ³gica. VersiÃ³n 3.0</p>
    </footer>
</body>
</html>
